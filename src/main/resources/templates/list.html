<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
        }

        .post {
            border-bottom: 1px solid #ccc;
            padding: 10px 0;
        }

        .post img {
            max-width: 100%;
            height: auto;
            max-height: 200px;
        }

        .tags span {
            display: inline-block;
            background: #0073e6;
            color: white;
            padding: 3px 8px;
            margin: 3px;
            border-radius: 5px;
            font-size: 14px;
        }

        .pagination a {
            margin: 0 5px;
            text-decoration: none;
            color: #0073e6;
        }

        .pagination a.active {
            font-weight: bold;
            text-decoration: underline;
        }

        .add-post-btn {
            background: #0073e6;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            width: 400px;
        }

        .close-btn {
            float: right;
            cursor: pointer;
            color: red;
        }
    </style>
</head>
<body>

<h1>–õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤</h1>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞ -->
<button class="add-post-btn" type="button" onclick="openModal()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç</button>

<form action="/posts" method="get">
    <label for="size">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</label>
    <select name="size" id="size">
        <option value="10" th:selected="${size == 10}">10</option>
        <option value="20" th:selected="${size == 20}">20</option>
        <option value="50" th:selected="${size == 50}">50</option>
    </select>
    <button type="submit">–ò–∑–º–µ–Ω–∏—Ç—å</button>
</form>

<!-- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–≥—É -->
<form action="/posts" method="get">
    <label for="tag">–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥—É:</label>
    <select name="tag" id="tag">
        <option value="">–í—Å–µ</option>
        <option th:each="tag : ${tags}"
                th:value="${tag}"
                th:text="${tag}"
                th:selected="${tag == selectedTag}">
        </option>
    </select>
    <button type="submit">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
</form>

<!-- –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ -->
<div th:each="post : ${posts}" class="post">
    <h2><a th:href="@{/posts/{id}(id=${post.id})}" th:text="${post.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞</a></h2>
    <img th:src="@{/posts/{id}/image(id=${post.id})}" alt="–ü—Ä–µ–≤—å—é –ø–æ—Å—Ç–∞">
    <p class="short-description" th:text="${post.text}"></p>

    <p>‚ù§Ô∏è <span th:text="${post.likes}">0</span> | üí¨ <span th:text="${#lists.size(post.comments)}">0</span>

    <div class="tags">
        <span th:each="tag : ${post.tags}" th:text="${tag}">–¢–µ–≥</span>
    </div>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div class="pagination">
    <a th:each="page : ${#numbers.sequence(0, totalPages - 1)}"
       th:href="@{/posts(page=${page}, size=${size}, tag=${selectedTag})}"
       th:text="${page + 1}"
       th:classappend="${page == currentPage} ? 'active' : ''"></a>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞ -->
<div id="addPostModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">√ó</span>
        <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç</h2>
        <form action="/posts/add" method="post" enctype="multipart/form-data">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" name="title" required><br>

            <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞:</label>
            <input type="file" name="image" accept="image/*" required><br>

            <label>–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞:</label>
            <textarea name="text" rows="4" required></textarea><br>

            <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
            <input type="text" name="tags"><br>

            <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </form>
    </div>
</div>

<script>
    function openModal() {
        document.getElementById('addPostModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('addPostModal').style.display = 'none';
    }

    // —Å–æ–∫—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø—Ä–µ–≤—å—é
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".short-description").forEach(function (element) {
            let fullText = element.textContent.trim();
            if (fullText.length > 100) {
                element.textContent = fullText.substring(0, 100) + "...";
            }
        });
    });

    // –ì—Ä—É–∑–∏–º —Ç–µ–≥–∏ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
    document.addEventListener("DOMContentLoaded", function () {
        const contextPath = window.location.pathname.split('/')[1];  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º "blog"
        fetch('/api/tags', {
            headers: {'Accept': 'application/json'}
        })
            .then(response => response.json())
            .then(tags => {
                const tagSelect = document.getElementById("tag");
                if (!tagSelect) {
                    console.error("–û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç #tag –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    return;
                }

                const urlParams = new URLSearchParams(window.location.search);
                const selectedTag = urlParams.get('tag');

                tags.forEach(tag => {
                    const option = document.createElement("option");
                    option.value = tag;
                    option.textContent = tag;
                    if (tag === selectedTag) {
                        option.selected = true;
                    }
                    tagSelect.appendChild(option);
                });
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–≥–æ–≤:", error));
    });

</script>

</body>
</html>
